---
- name: Deploy YOLO E-commerce Application
  hosts: all
  become: yes
  vars_files:
    - vars/main.yml
  
  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      ignore_errors: yes
      tags: always
    
    - name: Install system packages
      apt:
        name: [git, curl, python3-pip, apt-transport-https]
        state: present
      tags: setup
  
  roles:
    - { role: docker, tags: [docker, setup] }
    - { role: clone_repo, tags: [clone, setup] }
    - { role: mongodb, tags: [mongodb, containers] }
    - { role: backend, tags: [backend, containers] }
    - { role: client, tags: [client, containers] }
  
  post_tasks:
    - name: Display deployment info
      debug:
        msg:
          - "Deployment Complete!"
          - "Frontend: http://{{ ansible_default_ipv4.address }}:3000"
          - "Backend: http://{{ ansible_default_ipv4.address }}:5000/api/products"
      tags: always
