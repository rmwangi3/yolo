---
- name: Build client image
  docker_image:
    name: "{{ client_image }}"
    build:
      path: "{{ client_context }}"
    source: build
    force_source: yes

- name: Stop existing client container
  docker_container:
    name: "{{ client_container_name }}"
    state: absent
  ignore_errors: yes

- name: Start client container
  docker_container:
    name: "{{ client_container_name }}"
    image: "{{ client_image }}"
    state: started
    restart_policy: unless-stopped
    networks:
          - name: "{{ docker_network_name }}"
        ports:
          - "{{ client_port }}:{{ client_nginx_port }}"
      tags:
        - client-deploy
    
    - name: Wait for client to be ready
      wait_for:
        port: "{{ client_port }}"
        delay: 5
        timeout: 60
      tags:
        - client-wait
  tags:
    - client-deployment
