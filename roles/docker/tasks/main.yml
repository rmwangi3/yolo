---
- name: Install Docker GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present

- name: Install Docker
  apt:
    name: [docker-ce, docker-ce-cli, containerd.io, docker-compose-plugin]
    state: present
    update_cache: yes

- name: Start Docker service
  service:
    name: docker
    state: started
    enabled: yes

- name: Add user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

  tags:
    - docker-setup

- name: Configure Docker users and permissions
  block:
    - name: Add users to docker group
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop: "{{ docker_users }}"
      when: docker_users is defined
      tags:
        - docker-users
    
    - name: Reset SSH connection to apply group changes
      meta: reset_connection
      tags:
        - docker-users
  tags:
    - docker-configuration

- name: Install Docker Compose standalone (legacy support)
  block:
    - name: Download Docker Compose binary
      get_url:
        url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      tags:
        - docker-compose
    
    - name: Verify Docker Compose installation
      command: docker-compose --version
      register: docker_compose_version_output
      changed_when: false
      tags:
        - docker-compose
    
    - name: Display Docker Compose version
      debug:
        var: docker_compose_version_output.stdout
      tags:
        - docker-compose
  tags:
    - docker-setup

- name: Install Python Docker SDK
  pip:
    name:
      - docker
      - docker-compose
    state: present
    executable: pip3
  tags:
    - docker-python

- name: Verify Docker installation
  block:
    - name: Check Docker version
      command: docker --version
      register: docker_version_output
      changed_when: false
      tags:
        - docker-verify
    
    - name: Display Docker version
      debug:
        var: docker_version_output.stdout
      tags:
        - docker-verify
    
    - name: Test Docker with hello-world
      docker_container:
        name: hello-world-test
        image: hello-world
        state: started
        detach: no
        cleanup: yes
        auto_remove: yes
      tags:
        - docker-verify
  tags:
    - docker-verification
