apiVersion: batch/v1
kind: Job
metadata:
  name: mongo-init-replicaset
  namespace: yolo
spec:
  backoffLimit: 4
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mongo-init
        image: mongo:4.4
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for mongo pods..."
          for i in 0 1 2; do
            until mongo --host mongo-${i}.mongo-headless.yolo.svc.cluster.local --eval 'db.adminCommand({ping:1})' >/dev/null 2>&1; do
              echo "waiting for mongo-$i..."
              sleep 2
            done
          done
          echo "Initiating replica set..."
          mongo --host mongo-0.mongo-headless.yolo.svc.cluster.local <<'EOF'
            rs.initiate({_id: 'rs0', members: [
              {_id: 0, host: 'mongo-0.mongo-headless.yolo.svc.cluster.local:27017'},
              {_id: 1, host: 'mongo-1.mongo-headless.yolo.svc.cluster.local:27017'},
              {_id: 2, host: 'mongo-2.mongo-headless.yolo.svc.cluster.local:27017'}
            ]})
            rs.status()
          EOF
          echo "Replica set initiation attempted"
