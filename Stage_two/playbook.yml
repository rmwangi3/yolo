---
- name: Deploy YOLO E-commerce Application with Docker (Stage 2)
  hosts: yolo_server
  become: yes
  gather_facts: yes

  vars_files:
    - ../vars/main.yml

  roles:
    - role: ../roles/docker
      tags: docker
    
    - role: ../roles/clone_repo
      tags: clone
    
    - role: ../roles/mongodb
      tags: mongodb
    
    - role: ../roles/backend
      tags: backend
    
    - role: ../roles/client
      tags: client

  post_tasks:
    - name: Verify all containers are running
      block:
        - name: Check running containers
          command: docker ps
          register: containers_status
          tags: verify

        - name: Display container status
          debug:
            msg: "{{ containers_status.stdout_lines }}"
          tags: verify

        - name: Wait for application to be ready
          wait_for:
            host: localhost
            port: 3000
            delay: 10
            timeout: 60
          tags: verify

        - name: Display deployment success message
          debug:
            msg: "Application deployed successfully! Access at http://localhost:3000"
          tags: verify
